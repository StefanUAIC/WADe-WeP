<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualize - Provenance Platform</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        #graph-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            height: 700px;
            position: relative;
        }
        .graph-controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .legend {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .legend-items {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .legend-color {
            width: 25px;
            height: 25px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">üì∞ Provenance Platform</div>
            <ul class="nav-menu">
                <li><a href="/">Home</a></li>
                <li><a href="/browse">Browse</a></li>
                <li><a href="/query">Query</a></li>
                <li><a href="/sparql">SPARQL</a></li>
                <li><a href="/upload">Upload</a></li>
                <li><a href="/visualize" class="active">Visualize</a></li>
            </ul>
        </div>
    </nav>
    <div class="container">
        <header class="page-header">
            <h1>üåê Provenance Graph Visualization</h1>
            <p>Interactive force-directed graph of provenance relationships</p>
        </header>
        <div class="graph-controls">
            <button onclick="loadGraph()" class="btn-primary">Load Graph</button>
            <button onclick="resetZoom()" class="btn-secondary">Reset Zoom</button>
            <button onclick="toggleLabels()" class="btn-secondary">Toggle Labels</button>
        </div>
        <div class="legend">
            <h3 style="margin-bottom: 15px; color: #667eea;">Legend</h3>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color" style="background: #64b5f6;"></div>
                    <span>Entity</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffb74d;"></div>
                    <span>Activity</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ba68c8;"></div>
                    <span>Agent</span>
                </div>
            </div>
        </div>
        <div id="graph-container"></div>
    </div>
    <script src="js/common.js"></script>
    <script>
        let simulation, svg, g, showLabels = true;

        async function loadGraph() {
            const container = document.getElementById('graph-container');
            container.innerHTML = '<div class="loading">Loading graph...</div>';

            try {
                const response = await fetch('/api/provenance-graph');
                const data = await response.json();
                
                if (data.results && data.results.bindings) {
                    const graphData = processGraphData(data.results.bindings);
                    renderGraph(graphData);
                    showNotification('Graph loaded', 'success');
                } else {
                    container.innerHTML = '<div class="empty-state">No graph data available</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error-state">Error: ${error.message}</div>`;
            }
        }

        function processGraphData(bindings) {
            const nodes = new Map();
            const links = [];

            bindings.forEach(b => {
                const subject = b.subject.value;
                const subjectType = getShortName(b.subjectType.value);
                const predicate = getShortName(b.predicate.value);
                const object = b.object.value;
                const objectType = b.objectType ? getShortName(b.objectType.value) : null;

                if (!nodes.has(subject)) {
                    nodes.set(subject, {
                        id: subject,
                        label: getShortName(subject),
                        type: subjectType
                    });
                }

                if (isValidUri(object)) {
                    if (!nodes.has(object)) {
                        nodes.set(object, {
                            id: object,
                            label: getShortName(object),
                            type: objectType || 'Unknown'
                        });
                    }
                    links.push({
                        source: subject,
                        target: object,
                        type: predicate
                    });
                }
            });

            return {
                nodes: Array.from(nodes.values()),
                links: links
            };
        }

        function renderGraph(data) {
            const container = document.getElementById('graph-container');
            container.innerHTML = '';

            const width = container.clientWidth;
            const height = container.clientHeight;

            svg = d3.select('#graph-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            g = svg.append('g');

            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => g.attr('transform', event.transform));
            svg.call(zoom);

            const colorMap = {
                'Entity': '#64b5f6',
                'Activity': '#ffb74d',
                'Agent': '#ba68c8',
                'Person': '#9575cd',
                'Organization': '#7986cb'
            };

            simulation = d3.forceSimulation(data.nodes)
                .force('link', d3.forceLink(data.links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));

            const link = g.append('g')
                .selectAll('line')
                .data(data.links)
                .enter()
                .append('line')
                .attr('stroke', '#999')
                .attr('stroke-width', 2)
                .attr('stroke-opacity', 0.6);

            const linkLabel = g.append('g')
                .selectAll('text')
                .data(data.links)
                .enter()
                .append('text')
                .attr('font-size', 10)
                .attr('fill', '#666')
                .text(d => d.type);

            const node = g.append('g')
                .selectAll('circle')
                .data(data.nodes)
                .enter()
                .append('circle')
                .attr('r', 15)
                .attr('fill', d => colorMap[d.type] || '#888')
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .style('cursor', 'pointer')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))
                .on('click', (event, d) => {
                    window.location.href = `/browse?resource=${encodeURIComponent(d.id)}`;
                });

            const nodeLabel = g.append('g')
                .selectAll('text')
                .data(data.nodes)
                .enter()
                .append('text')
                .attr('font-size', 12)
                .attr('dx', 20)
                .attr('dy', 5)
                .text(d => d.label);

            node.append('title').text(d => `${d.label} (${d.type})`);

            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                linkLabel
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                nodeLabel
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        function resetZoom() {
            svg.transition().duration(750).call(
                d3.zoom().transform,
                d3.zoomIdentity
            );
        }

        function toggleLabels() {
            showLabels = !showLabels;
            d3.selectAll('#graph-container text')
                .style('display', showLabels ? 'block' : 'none');
        }

        loadGraph();
    </script>
</body>
</html>